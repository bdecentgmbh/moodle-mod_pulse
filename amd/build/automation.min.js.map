{"version":3,"file":"automation.min.js","sources":["../src/automation.js"],"sourcesContent":["define(\"mod_pulse/automation\", ['jquery', 'core/modal_factory', 'core/templates', 'core/str'], function($, Modal, Template, Str) {\r\n\r\n    const moveOutMoreMenu = (navMenu) => {\r\n\r\n        if (navMenu === null) {\r\n            return;\r\n        }\r\n\r\n        var menu = navMenu.querySelector('a.automation-templates');\r\n\r\n        if (menu === null) {\r\n            return;\r\n        }\r\n\r\n        menu = menu.parentNode;\r\n        menu.dataset.forceintomoremenu = false,\r\n        menu.querySelector('a').classList.remove('dropdown-item');\r\n        menu.querySelector('a').classList.add('nav-link');\r\n        menu.parentNode.removeChild(menu);\r\n\r\n        // Insert the stored menus before the more menu.\r\n        navMenu.insertBefore(menu, navMenu.children[1]);\r\n        window.dispatchEvent(new Event('resize')); // Dispatch the resize event to create more menu.\r\n    };\r\n\r\n    const returnToFailedTab = () => {\r\n\r\n        if (document.forms['pulse-automation-template'] === null) {\r\n            return false;\r\n        }\r\n\r\n        document.forms['pulse-automation-template'].onsubmit = (e) => {\r\n            var form = e.target;\r\n            var invalidElement = form.querySelector('.is-invalid');\r\n            if (invalidElement === null) {\r\n                return true;\r\n            }\r\n\r\n            var tabid = invalidElement.parentNode.parentNode.parentNode.id;\r\n            var hrefSelector = '[href=\"#'+tabid+'\"]';\r\n\r\n            document.querySelector(hrefSelector).click();\r\n        }\r\n    };\r\n\r\n    // No need.\r\n    const updateAutoCompletionPositions = function() {\r\n        var group = \"checkboxgroupautomation\";\r\n\r\n        if (document.querySelectorAll('input[type=checkbox].'+group) === null || document.querySelectorAll('[data-fieldtype=\"autocomplete\"]') === null) {\r\n            return true;\r\n        }\r\n\r\n        document.querySelectorAll('[data-fieldtype=\"autocomplete\"]').forEach((element) => {\r\n\r\n            if (element === null) {\r\n                return true;\r\n            }\r\n\r\n            var observer = new MutationObserver(function(mutations) {\r\n                mutations.forEach((mutation) => {\r\n                    console.log(mutation);\r\n                    // if(mutation.type === 'attributes') {\r\n                    target = mutation.target;\r\n                    var overrideElement = target.querySelector('.custom-switch');\r\n                    if (overrideElement === null) {\r\n                        return;\r\n                    }\r\n                    overrideElement.parentNode.append(overrideElement);\r\n                    observer.disconnect();\r\n                })\r\n            });\r\n            observer.observe(element, { attributes: true, childList: true, subtree: true, });\r\n            // observer.disconnect();\r\n        })\r\n    }\r\n\r\n    const moveOverRidePosition = function() {\r\n\r\n        var group = \"checkboxgroupautomation\";\r\n\r\n        if (document.querySelectorAll('input[type=checkbox].'+group) === null) {\r\n            return true;\r\n        }\r\n\r\n        document.querySelectorAll('input[type=checkbox].'+group).forEach((overElement) => {\r\n            var id = overElement.id;\r\n            id = id.replace('id_override_', '');\r\n            var element = document.querySelector('div#fitem_id_'+id);\r\n            if (element === null) {\r\n                element = document.querySelector('div#fgroup_id_'+id);\r\n                if (element === null) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            var parent = overElement.parentNode;\r\n            parent.innerHTML += '<span class=\"custom-control-label\"></span>';\r\n\r\n            var nodeToMove = document.createElement('div');\r\n            nodeToMove.classList.add('custom-control', 'custom-switch');\r\n            nodeToMove.append(parent);\r\n            element.querySelector(\".felement\").append(nodeToMove);\r\n        });\r\n        // Move the override button for autocompletion fields after the autocomplete nodes are created.\r\n        updateAutoCompletionPositions();\r\n    }\r\n\r\n    /**\r\n     * Create a modal to display the list of instances which is overriden the template setting.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    const overrideModal = function() {\r\n\r\n        // Add the template reference as prefix of the instance reference.\r\n        var templateReference = document.querySelector('#pulse-template-reference');\r\n        var instanceReference = document.querySelector('#fitem_id_insreference .felement');\r\n        if (templateReference && instanceReference) {\r\n            templateReference.classList.remove('hide');\r\n            instanceReference.prepend(templateReference);\r\n        }\r\n\r\n        const trigger = document.querySelectorAll('[data-target=\"overridemodal\"]');\r\n\r\n        if (trigger === null) {\r\n            return;\r\n        }\r\n\r\n        trigger.forEach((elem) => {\r\n\r\n            elem.nextSibling.querySelector('.felement').append(elem);\r\n\r\n            elem.addEventListener('click', function(e) {\r\n                e.preventDefault();\r\n                var element = e.target;\r\n                var data = element.dataset;\r\n                var instance = document.querySelector('[name=overinstance_'+data.element+']');\r\n                if (instance !== null) {\r\n                    var overrides = JSON.parse(instance.value);\r\n                    overrides.map((value) => {\r\n                        value.url = M.cfg.wwwroot+'/mod/pulse/automation/instances/edit.php?instanceid='+value.id+'&sesskey='+M.cfg.sesskey\r\n                        return value;\r\n                    })\r\n                    Modal.create({\r\n                        title: Str.get_string('instanceoverrides', 'pulse'),\r\n                        body: Template.render('mod_pulse/overrides', {instances: overrides})\r\n                    }).then((modal) => {\r\n                        modal.show();\r\n                    });\r\n                }\r\n            })\r\n        })\r\n    };\r\n\r\n    return {\r\n\r\n        init: function() {\r\n            returnToFailedTab();\r\n            overrideModal();\r\n            moveOverRidePosition();\r\n        },\r\n\r\n        instanceMenuLink: function() {\r\n            var primaryNav = document.querySelector('.secondary-navigation ul.more-nav');\r\n            moveOutMoreMenu(primaryNav);\r\n        },\r\n\r\n    }\r\n})\r\n"],"names":["define","$","Modal","Template","Str","moveOverRidePosition","group","document","querySelectorAll","forEach","overElement","id","replace","element","querySelector","parent","parentNode","innerHTML","nodeToMove","createElement","classList","add","append","observer","MutationObserver","mutations","mutation","console","log","target","overrideElement","disconnect","observe","attributes","childList","subtree","updateAutoCompletionPositions","init","forms","onsubmit","e","invalidElement","hrefSelector","click","returnToFailedTab","templateReference","instanceReference","remove","prepend","trigger","elem","nextSibling","addEventListener","preventDefault","data","dataset","instance","overrides","JSON","parse","value","map","url","M","cfg","wwwroot","sesskey","create","title","get_string","body","render","instances","then","modal","show","overrideModal","instanceMenuLink","navMenu","menu","forceintomoremenu","removeChild","insertBefore","children","window","dispatchEvent","Event","moveOutMoreMenu"],"mappings":"AAAAA,8BAA+B,CAAC,SAAU,qBAAsB,iBAAkB,aAAa,SAASC,EAAGC,MAAOC,SAAUC,WA6ElHC,qBAAuB,eAErBC,MAAQ,6BAEqD,OAA7DC,SAASC,iBAAiB,wBAAwBF,cAC3C,EAGXC,SAASC,iBAAiB,wBAAwBF,OAAOG,SAASC,kBAC1DC,GAAKD,YAAYC,GACrBA,GAAKA,GAAGC,QAAQ,eAAgB,QAC5BC,QAAUN,SAASO,cAAc,gBAAgBH,OACrC,OAAZE,SAEgB,QADhBA,QAAUN,SAASO,cAAc,iBAAiBH,YAEvC,MAIXI,OAASL,YAAYM,WACzBD,OAAOE,WAAa,iDAEhBC,WAAaX,SAASY,cAAc,OACxCD,WAAWE,UAAUC,IAAI,iBAAkB,iBAC3CH,WAAWI,OAAOP,QAClBF,QAAQC,cAAc,aAAaQ,OAAOJ,eAxDZ,cAG+B,OAA7DX,SAASC,iBAAiB,iDAA4G,OAAjED,SAASC,iBAAiB,0CACxF,EAGXD,SAASC,iBAAiB,mCAAmCC,SAASI,aAElD,OAAZA,eACO,MAGPU,SAAW,IAAIC,kBAAiB,SAASC,WACzCA,UAAUhB,SAASiB,WACfC,QAAQC,IAAIF,UAEZG,OAASH,SAASG,WACdC,gBAAkBD,OAAOf,cAAc,kBACnB,OAApBgB,kBAGJA,gBAAgBd,WAAWM,OAAOQ,iBAClCP,SAASQ,oBAGjBR,SAASS,QAAQnB,QAAS,CAAEoB,YAAY,EAAMC,WAAW,EAAMC,SAAS,OAiC5EC,UAkDG,CAEHC,KAAM,WApIgB,SAE8B,OAAhD9B,SAAS+B,MAAM,oCACR,EAGX/B,SAAS+B,MAAM,6BAA6BC,SAAYC,QAEhDC,eADOD,EAAEX,OACaf,cAAc,kBACjB,OAAnB2B,sBACO,MAIPC,aAAe,WADPD,eAAezB,WAAWA,WAAWA,WAAWL,GACxB,KAEpCJ,SAASO,cAAc4B,cAAcC,UAqHrCC,GA7Cc,eAGdC,kBAAoBtC,SAASO,cAAc,6BAC3CgC,kBAAoBvC,SAASO,cAAc,oCAC3C+B,mBAAqBC,oBACrBD,kBAAkBzB,UAAU2B,OAAO,QACnCD,kBAAkBE,QAAQH,0BAGxBI,QAAU1C,SAASC,iBAAiB,iCAE1B,OAAZyC,SAIJA,QAAQxC,SAASyC,OAEbA,KAAKC,YAAYrC,cAAc,aAAaQ,OAAO4B,MAEnDA,KAAKE,iBAAiB,SAAS,SAASZ,GACpCA,EAAEa,qBAEEC,KADUd,EAAEX,OACG0B,QACfC,SAAWjD,SAASO,cAAc,sBAAsBwC,KAAKzC,QAAQ,QACxD,OAAb2C,SAAmB,KACfC,UAAYC,KAAKC,MAAMH,SAASI,OACpCH,UAAUI,KAAKD,QACXA,MAAME,IAAMC,EAAEC,IAAIC,QAAQ,uDAAuDL,MAAMjD,GAAG,YAAYoD,EAAEC,IAAIE,QACrGN,SAEX1D,MAAMiE,OAAO,CACTC,MAAOhE,IAAIiE,WAAW,oBAAqB,SAC3CC,KAAMnE,SAASoE,OAAO,sBAAuB,CAACC,UAAWf,cAC1DgB,MAAMC,QACLA,MAAMC,iBAWlBC,GACAvE,wBAGJwE,iBAAkB,WAjKGC,CAAAA,aAEL,OAAZA,aAIAC,KAAOD,QAAQhE,cAAc,0BAEpB,OAATiE,QAIJA,KAAOA,KAAK/D,YACPuC,QAAQyB,mBAAoB,EACjCD,KAAKjE,cAAc,KAAKM,UAAU2B,OAAO,iBACzCgC,KAAKjE,cAAc,KAAKM,UAAUC,IAAI,YACtC0D,KAAK/D,WAAWiE,YAAYF,MAG5BD,QAAQI,aAAaH,KAAMD,QAAQK,SAAS,IAC5CC,OAAOC,cAAc,IAAIC,MAAM,cA+I3BC,CADiBhF,SAASO,cAAc"}