{"version":3,"file":"automation.min.js","sources":["../src/automation.js"],"sourcesContent":["define(\"mod_pulse/automation\", ['jquery', 'core/modal_factory', 'core/templates', 'core/str'], function($, Modal, Template, Str) {\r\n\r\n    const moveOutMoreMenu = (navMenu) => {\r\n\r\n        if (navMenu === null) {\r\n            return;\r\n        }\r\n\r\n        var menu = navMenu.querySelector('a.automation-templates');\r\n\r\n        if (menu === null) {\r\n            return;\r\n        }\r\n\r\n        menu = menu.parentNode;\r\n        menu.dataset.forceintomoremenu = false;\r\n        menu.querySelector('a').classList.remove('dropdown-item');\r\n        menu.querySelector('a').classList.add('nav-link');\r\n        menu.parentNode.removeChild(menu);\r\n\r\n        // Insert the stored menus before the more menu.\r\n        navMenu.insertBefore(menu, navMenu.children[1]);\r\n        window.dispatchEvent(new Event('resize')); // Dispatch the resize event to create more menu.\r\n    };\r\n\r\n    const returnToFailedTab = () => {\r\n\r\n        if (document.forms['pulse-automation-template'] === null) {\r\n            return false;\r\n        }\r\n\r\n        document.forms['pulse-automation-template'].onsubmit = (e) => {\r\n            var form = e.target;\r\n            var invalidElement = form.querySelector('.is-invalid');\r\n            if (invalidElement === null) {\r\n                return true;\r\n            }\r\n\r\n            var tabid = invalidElement.parentNode.parentNode.parentNode.id;\r\n            var hrefSelector = '[href=\"#' + tabid + '\"]';\r\n\r\n            document.querySelector(hrefSelector).click();\r\n\r\n            return true;\r\n        };\r\n\r\n        return true;\r\n    };\r\n\r\n    // No need.\r\n    const updateAutoCompletionPositions = function() {\r\n        var group = \"checkboxgroupautomation\";\r\n\r\n        if (document.querySelectorAll('input[type=checkbox].' + group)\r\n            === null || document.querySelectorAll('[data-fieldtype=\"autocomplete\"]') === null) {\r\n            return true;\r\n        }\r\n\r\n        document.querySelectorAll('[data-fieldtype=\"autocomplete\"]').forEach((element) => {\r\n\r\n            if (element === null) {\r\n                return true;\r\n            }\r\n\r\n            var observer = new MutationObserver(function(mutations) {\r\n                mutations.forEach((mutation) => {\r\n                    // Console.log(mutation);\r\n                    // If(mutation.type === 'attributes') {\r\n                    var target = mutation.target;\r\n                    var overrideElement = target.querySelector('.custom-switch');\r\n                    if (overrideElement === null) {\r\n                        return;\r\n                    }\r\n                    overrideElement.parentNode.append(overrideElement);\r\n                    observer.disconnect();\r\n                });\r\n            });\r\n            observer.observe(element, {attributes: true, childList: true, subtree: true});\r\n            // Observer.disconnect();\r\n            return true;\r\n        });\r\n\r\n        return true;\r\n    };\r\n\r\n    const moveOverRidePosition = function() {\r\n\r\n        var group = \"checkboxgroupautomation\";\r\n\r\n        if (document.querySelectorAll('input[type=checkbox].' + group) === null) {\r\n            return true;\r\n        }\r\n\r\n        document.querySelectorAll('input[type=checkbox].' + group).forEach((overElement) => {\r\n            var id = overElement.id;\r\n            id = id.replace('id_override_', '');\r\n            var element = document.querySelector('div#fitem_id_' + id);\r\n            if (element === null) {\r\n                element = document.querySelector('div#fgroup_id_' + id);\r\n                if (element === null) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            var parent = overElement.parentNode;\r\n            parent.innerHTML += '<span class=\"custom-control-label\"></span>';\r\n\r\n            var nodeToMove = document.createElement('div');\r\n            nodeToMove.classList.add('custom-control', 'custom-switch');\r\n            nodeToMove.append(parent);\r\n            element.querySelector(\".felement\").append(nodeToMove);\r\n            return true;\r\n        });\r\n        // Move the override button for autocompletion fields after the autocomplete nodes are created.\r\n        updateAutoCompletionPositions();\r\n\r\n        return true;\r\n    };\r\n\r\n    /**\r\n     * Create a modal to display the list of instances which is overriden the template setting.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    const overrideModal = function() {\r\n\r\n        // Add the template reference as prefix of the instance reference.\r\n        var templateReference = document.querySelector('#pulse-template-reference');\r\n        var instanceReference = document.querySelector('#fitem_id_insreference .felement');\r\n        if (templateReference && instanceReference) {\r\n            templateReference.classList.remove('hide');\r\n            instanceReference.prepend(templateReference);\r\n        }\r\n\r\n        const trigger = document.querySelectorAll('[data-target=\"overridemodal\"]');\r\n\r\n        if (trigger === null) {\r\n            return;\r\n        }\r\n\r\n        trigger.forEach((elem) => {\r\n\r\n            elem.nextSibling.querySelector('.felement').append(elem);\r\n\r\n            elem.addEventListener('click', function(e) {\r\n                e.preventDefault();\r\n                var element = e.target;\r\n                var data = element.dataset;\r\n                var instance = document.querySelector('[name=overinstance_' + data.element + ']');\r\n                if (instance !== null) {\r\n                    var overrides = JSON.parse(instance.value);\r\n                    overrides.map((value) => {\r\n                        var path = '/mod/pulse/automation/instances/edit.php?instanceid=';\r\n                        value.url = M.cfg.wwwroot + path + value.id + '&sesskey=' + M.cfg.sesskey;\r\n                        return value;\r\n                    });\r\n                    Modal.create({\r\n                        title: Str.get_string('instanceoverrides', 'pulse'),\r\n                        body: Template.render('mod_pulse/overrides', {instances: overrides})\r\n                    }).then((modal) => {\r\n                        modal.show();\r\n                        return true;\r\n                    }).catch();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    const enableTitleOnSubmit = function() {\r\n        if (document.forms['pulse-automation-template'] === null) {\r\n            return;\r\n        }\r\n        document.forms['pulse-automation-template'].onsubmit =\r\n            () => document.querySelector('[name=\"title\"]').removeAttribute(\"disabled\");\r\n    };\r\n\r\n    return {\r\n\r\n        init: function() {\r\n            returnToFailedTab();\r\n            overrideModal();\r\n            moveOverRidePosition();\r\n            enableTitleOnSubmit();\r\n        },\r\n\r\n        instanceMenuLink: function() {\r\n            var primaryNav = document.querySelector('.secondary-navigation ul.more-nav');\r\n            moveOutMoreMenu(primaryNav);\r\n        },\r\n\r\n    };\r\n});\r\n"],"names":["define","$","Modal","Template","Str","moveOverRidePosition","group","document","querySelectorAll","forEach","overElement","id","replace","element","querySelector","parent","parentNode","innerHTML","nodeToMove","createElement","classList","add","append","observer","MutationObserver","mutations","mutation","overrideElement","target","disconnect","observe","attributes","childList","subtree","init","forms","onsubmit","e","invalidElement","hrefSelector","click","templateReference","instanceReference","remove","prepend","trigger","elem","nextSibling","addEventListener","preventDefault","data","dataset","instance","overrides","JSON","parse","value","map","url","M","cfg","wwwroot","sesskey","create","title","get_string","body","render","instances","then","modal","show","catch","overrideModal","removeAttribute","instanceMenuLink","navMenu","menu","forceintomoremenu","removeChild","insertBefore","children","window","dispatchEvent","Event","moveOutMoreMenu"],"mappings":"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"}