{"version":3,"file":"preset.min.js","sources":["../src/preset.js"],"sourcesContent":["define(['jquery', 'core/modal_factory', 'mod_pulse/modal_preset', 'mod_pulse/events', 'core/str', 'core/fragment', 'core/ajax',\n    'core/templates', 'core/loadingicon', 'core/notification', 'core/modal_events', 'mod_pulse/presetmodal'],\n    function($, Modal, ModalPreset, PresetEvents, Str, Fragment, AJAX, Templates, Loadingicon,\n        Notification, ModalEvents, PresetModal) {\n\n        var SELECTOR = {\n            presetAvailability: '.preset-config-params .availability-field'\n        };\n\n        /**\n         * Preset module declaration. Setup the global values.\n         * @param  {int} contextId\n         * @param  {int} courseid\n         * @param  {int} section\n         */\n        var Preset = function(contextId, courseid, section) {\n            this.contextId = contextId;\n            this.courseid = courseid;\n            this.section = section;\n            this.loadPresetsList();\n        };\n\n        Preset.prototype.listElement = {'selector': 'pulse-presets-data', \"loaded\": \"data-listloaded\" };\n\n        Preset.prototype.contextId = 0;\n\n        Preset.prototype.courseid = 0;\n\n        Preset.prototype.section = 0;\n\n        Preset.prototype.pageparams = [];\n\n        Preset.prototype.loadIconElement = '.modal-footer #loader-icon';\n\n        Preset.prototype.actionbuttons = '.modal-footer button';\n\n        /**\n         * Setup the presets modal event listeners.\n         */\n        Preset.prototype.setupmodal = function() {\n\n            var THIS = this;\n\n            var triggerelement = document.querySelectorAll('.pulse-usepreset');\n            // Modal attachment point.\n            var attachmentPoint = document.createElement('div');\n            attachmentPoint.classList.add('modal-preset');\n            triggerelement.forEach((element) => element.addEventListener('click', () => {\n                var presetid = element.getAttribute('data-presetid');\n                var presettitle = element.getAttribute('data-presettitle');\n                var params = {'presetid': presetid, 'courseid': THIS.courseid, 'section': THIS.section};\n\n                document.body.prepend(attachmentPoint);\n\n                var modalFn;\n                if (typeof PresetModal.registerModalType == 'undefined') {\n                    modalFn = Modal.create({\n                        type: ModalPreset.TYPE,\n                        title: Str.get_string('presetmodaltitle', 'pulse', {'title': presettitle}),\n                        body: Fragment.loadFragment('mod_pulse', 'get_preset_preview', THIS.contextId, params),\n                        large: true,\n                    });\n                } else {\n                    modalFn = PresetModal.create({\n                        title: Str.get_string('presetmodaltitle', 'pulse', {'title': presettitle}),\n                        body: Fragment.loadFragment('mod_pulse', 'get_preset_preview', THIS.contextId, params),\n                        large: true,\n                    });\n                }\n\n                modalFn.then(modal => {\n                    // Make the modal attachment point to overcome the restriction access condition.\n                    modal.attachmentPoint = attachmentPoint;\n                    modal.show();\n                    modal.getRoot().on(ModalEvents.bodyRendered, function() {\n                        THIS.reinitAvailability(SELECTOR.presetAvailability);\n                        THIS.fieldChangedEvent();\n                    });\n                    // Destroy the modal on hidden to reload the editors.\n                    modal.getRoot().on(ModalEvents.hidden, function() {\n                        modal.getRoot().get(0).querySelectorAll('form textarea').forEach(target => {\n                            if (typeof tinyMCE !== 'undefined') {\n                                tinyMCE.EditorManager.get(target.id).remove(); // eslint-disable-line\n                            }\n                        });\n                        modal.destroy.bind(modal);\n                        // THIS.reinitAvailability();\n                    });\n\n                    // Apply and customize method.\n                    modal.getRoot().on(PresetEvents.customize, () => {\n                        var modform = document.querySelector('#mod-pulse-form');\n                        var modformdata = new FormData(modform);\n                        modal.getRoot().get(0).querySelectorAll('form').forEach(form => {\n                            var formdata = new FormData(form);\n                            formdata = new URLSearchParams(formdata).toString();\n                            var pageparams = new URLSearchParams(modformdata).toString();\n                            params = {formdata: formdata, pageparams: pageparams};\n\n                            Loadingicon.addIconToContainer(this.loadIconElement);\n                            THIS.disableButtons();\n                            THIS.applyCustomize(params, THIS.contextId, modal);\n                        });\n                    });\n                    // Apply and save method.\n                    modal.getRoot().on(PresetEvents.save, (e) => {\n                        e.preventDefault();\n                        Loadingicon.addIconToContainer(this.loadIconElement);\n                        THIS.disableButtons();\n                        var formdata = {};\n                        modal.getRoot().get(0).querySelectorAll('form').forEach(form => {\n                            formdata = new FormData(form);\n                            this.restorePreset(formdata, THIS.contextId);\n                        });\n                    });\n                    return true;\n                }).catch(Notification.exception);\n            }));\n        };\n\n\n        Preset.prototype.fieldChangedEvent = () => {\n            var confParam = document.getElementById(\"preset-configurable-params\");\n            var reminders = ['first', 'second', 'recurring'];\n            var methods = ['fixed', 'relative'];\n            var fieldName, changeinput, id, changeName, split;\n            confParam.querySelectorAll('input, select, textarea').forEach(field => {\n                field.addEventListener('change', (event) => {\n                    fieldName = event.target.getAttribute('name');\n                    if (confParam.querySelector('input[name=\"' + fieldName + '_changed\"]') !== null) {\n                        confParam.querySelector('input[name=\"' + fieldName + '_changed\"]').value = true;\n                    }\n                });\n            });\n\n            reminders.forEach(reminder => {\n                confParam.querySelectorAll('[name=\"' + reminder + '_schedule\"').forEach(schedule => {\n                    schedule.addEventListener('change', (e) => {\n                        changeName = e.target.getAttribute('name');\n                        changeinput = 'input[name=\"' + changeName + '_arr_changed\"]';\n                        confParam.querySelector(changeinput).value = true;\n                    });\n                });\n                methods.forEach(method => {\n                    id = reminder + \"_\" + method + \"date\";\n                    confParam.querySelectorAll('[name*=\"' + id + '\"]').forEach(opt => {\n                        opt.addEventListener('change', (e) => {\n                            split = e.target.getAttribute('name').split('[');\n                            changeName = (split.hasOwnProperty(1)) ? split[0] : split;\n                            changeinput = 'input[name=\"' + changeName + '_changed\"]';\n                            confParam.querySelector(changeinput).value = true;\n                        });\n                    });\n                });\n            });\n        };\n\n        /**\n         * Reinitialize the availability javascript.\n         * @param {string} selector\n         */\n        Preset.prototype.reinitAvailability = function(selector = '.availability-field') {\n            if (typeof M.core_availability.form !== \"undefined\" &&\n                document.getElementById('id_availabilityconditionsjson') !== null) {\n                this.resetRestrictPlugins();\n                document.querySelectorAll(selector).forEach((field) => field.parentNode.removeChild(field));\n                M.core_availability.form.init();\n            }\n        };\n\n        Preset.prototype.resetRestrictPlugins = function() {\n            if (typeof M.core_availability.form !== \"undefined\" &&\n                document.getElementById('id_availabilityconditionsjson') !== null) {\n                M.core_availability.form.restrictByGroup = null;\n                var availabilityPlugins = (typeof M.core_availability.form.plugins !== 'undefined')\n                    ? M.core_availability.form.plugins : {};\n                var plugin = '';\n                for (var i in availabilityPlugins) {\n                    plugin = \"availability_\" + i;\n                    if (M.hasOwnProperty(plugin)) {\n                        M[plugin].form.addedEvents = false;\n                    }\n                }\n            }\n        };\n\n        /**\n         * Apply and customize triggered using fragment. Response will replaced with current mod form.\n         * @param  {string} params\n         * @param  {int} contextID\n         * @param  {object} modal\n         */\n        Preset.prototype.applyCustomize = function(params, contextID, modal) {\n            Fragment.loadFragment('mod_pulse', 'apply_preset', contextID, params).done((html, js) => {\n                modal.destroy();\n                // Reset the availability to work for upcoming response html.\n                this.resetRestrictPlugins();\n                this.handleFormSubmissionResponse(html, js);\n            });\n        };\n\n        /**\n         * Disable the modal save and customize buttons to prevent reinit.\n         */\n        Preset.prototype.disableButtons = function() {\n            var buttons = document.querySelectorAll(this.actionbuttons);\n            for (let $i in buttons) {\n                buttons[$i].disabled = true;\n            }\n        };\n\n        /**\n         * Handle the loaded fragment output of customize method pulse mod.\n         * @param  {html} data\n         * @param  {string} js\n         */\n        Preset.prototype.handleFormSubmissionResponse = (data, js) => {\n            var newform = document.createElement('div');\n            newform.innerHTML = data;\n            Templates.replaceNode('[action=\"modedit.php\"]', data, js);\n\n        };\n\n        /**\n         * Initiate the apply and save method to create the pulse module with custom daa.\n         * @param  {FormData} formdata\n         * @param  {int} contextid\n         */\n        Preset.prototype.restorePreset = (formdata, contextid) => {\n            var formdatastr = new URLSearchParams(formdata).toString();\n            var promises = AJAX.call([{\n                methodname: 'mod_pulse_apply_presets',\n                args: {contextid: contextid, formdata: formdatastr}\n            }]);\n\n            promises[0].done((response) => {\n                response = JSON.parse(response);\n                if (typeof response.url != 'undefined') {\n                    window.location.href = response.url;\n                }\n            });\n        };\n\n        /**\n         * Load list of available presets.\n         */\n        Preset.prototype.loadPresetsList = function() {\n            var listParent = document.getElementById(this.listElement.selector);\n\n            if (listParent !== null) {\n                if (listParent.getAttribute(this.listElement.loaded) == 'false') {\n                    Fragment.loadFragment('mod_pulse', 'get_presetslist', this.contextId, {'courseid': this.courseid})\n                        .done((html, js) => {\n                            Templates.replaceNodeContents(listParent, html, js);\n                            listParent.setAttribute(this.listElement.loaded, 'true');\n                            this.setupmodal();\n                        });\n                }\n            }\n        };\n\n        return {\n            init: (contextId, courseid, section) => {\n                new Preset(contextId, courseid, section);\n            }\n        };\n    });\n"],"names":["define","$","Modal","ModalPreset","PresetEvents","Str","Fragment","AJAX","Templates","Loadingicon","Notification","ModalEvents","PresetModal","SELECTOR","Preset","contextId","courseid","section","loadPresetsList","prototype","listElement","pageparams","loadIconElement","actionbuttons","setupmodal","THIS","this","triggerelement","document","querySelectorAll","attachmentPoint","createElement","classList","add","forEach","element","addEventListener","presetid","getAttribute","presettitle","params","body","prepend","registerModalType","create","type","TYPE","title","get_string","loadFragment","large","then","modal","show","getRoot","on","bodyRendered","reinitAvailability","fieldChangedEvent","hidden","get","target","tinyMCE","EditorManager","id","remove","destroy","bind","customize","modform","querySelector","modformdata","FormData","form","formdata","URLSearchParams","toString","addIconToContainer","disableButtons","applyCustomize","save","e","preventDefault","restorePreset","catch","exception","fieldName","changeinput","changeName","split","confParam","getElementById","methods","field","event","value","reminder","schedule","method","opt","hasOwnProperty","selector","M","core_availability","resetRestrictPlugins","parentNode","removeChild","init","restrictByGroup","availabilityPlugins","plugins","plugin","i","addedEvents","contextID","done","html","js","handleFormSubmissionResponse","buttons","$i","disabled","data","innerHTML","replaceNode","contextid","formdatastr","call","methodname","args","response","JSON","parse","url","window","location","href","listParent","loaded","replaceNodeContents","setAttribute"],"mappings":"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"}