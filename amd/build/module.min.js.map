{"version":3,"file":"module.min.js","sources":["../src/module.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module javascript to place the placeholders.\n * Modified version of IOMAD Email template emailvars.\n *\n * @module   mod_pulse/module\n * @category  Classes - autoloading\n * @copyright 2021, bdecent gmbh bdecent.de\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core_editor/events'], function () {\n\n    return {\n        /**\n         * Setup the classes to editors works with placeholders.\n         *\n         * @param {integer} branch\n         */\n        init: function (branch) {\n            var module = this;\n\n            var templatevars = document.getElementsByClassName(\"fitem_id_templatevars_editor\");\n            for (var l = 0; l < templatevars.length; l++) {\n                templatevars[l].addEventListener('click', function () {\n                    var EditorInput = document.getElementById('id_pulse_content_editoreditable');\n                    if (EditorInput !== null) {\n                        module.insertCaretActive(EditorInput);\n                    }\n                });\n            }\n\n            var notificationheader = document.getElementById('admin-notificationheader');\n            if (notificationheader !== null) {\n                notificationheader.addEventListener('click', function () {\n                    var EditorInput = (branch <= '402') ? document.getElementById('id_s_mod_pulse_notificationheadereditable')\n                        : document.getElementById('id_s_mod_pulse_notificationheader_ifr');\n                    module.insertCaretActive(EditorInput);\n                });\n            }\n\n            var notificationfooter = document.getElementById('admin-notificationfooter');\n            if (notificationfooter !== null) {\n                notificationfooter.addEventListener('click', function () {\n                    var EditorInput = (branch <= '402') ? document.getElementById('id_s_mod_pulse_notificationfootereditable')\n                        : document.getElementById('id_s_mod_pulse_notificationfooter_ifr');\n                    module.insertCaretActive(EditorInput);\n                });\n            }\n\n\n            templatevars = document.getElementsByClassName(\"fitem_id_templatevars_editor\");\n            if (templatevars) {\n                templatevars.forEach((elem) => {\n                    elem.addEventListener('click', function (e) {\n                        var target = e.currentTarget;\n                        var EditorInput = (branch <= \"402\")\n                            ? target.querySelector('[id*=\"_editoreditable\"]')\n                            : target.querySelector('textarea[id*=\"_content_editor\"]');\n                        module.insertCaretActive(EditorInput);\n                    });\n                });\n            }\n\n\n            var headertargetNode = document.querySelector('#id_s_mod_pulse_notificationheader');\n            if (headertargetNode !== null) {\n                let observer = new MutationObserver(function () {\n                    if (headertargetNode.style.display == 'none') {\n                        var headeriframe = document.querySelector('#admin-notificationheader iframe');\n                        if (headeriframe !== null) {\n                            var headercontent = document.querySelector('#admin-notificationheader iframe').contentDocument;\n                            headercontent.addEventListener('click', function () {\n                                var headercontentBody = headercontent.querySelector('body');\n                                if (headercontentBody !== null) {\n                                    headercontentBody.classList.add(\"insertatcaretactive\");\n                                }\n\n                                var footer = document.querySelector('#admin-notificationfooter iframe').contentDocument;\n                                var footerBody = footer.querySelector('body');\n                                if (footerBody.classList.contains('insertatcaretactive')) {\n                                    footerBody.classList.remove(\"insertatcaretactive\");\n                                }\n\n                            });\n                        }\n                    }\n                });\n                observer.observe(headertargetNode, { attributes: true, childList: true });\n            }\n\n            var footertargetNode = document.querySelector('#id_s_mod_pulse_notificationfooter');\n            if (footertargetNode !== null) {\n                let observer = new MutationObserver(function () {\n                    if (footertargetNode.style.display == 'none') {\n                        var footeriframe = document.querySelector('#admin-notificationfooter iframe');\n                        if (footeriframe !== null) {\n                            var footercontent = document.querySelector('#admin-notificationfooter iframe').contentDocument;\n                            footercontent.addEventListener('click', function () {\n                                var footercontentBody = footercontent.querySelector('body');\n                                if (footercontentBody !== null) {\n                                    footercontentBody.classList.add(\"insertatcaretactive\");\n                                }\n\n                                var header = document.querySelector('#admin-notificationheader iframe').contentDocument;\n                                var headerBody = header.querySelector('body');\n                                if (headerBody.classList.contains('insertatcaretactive')) {\n                                    headerBody.classList.remove(\"insertatcaretactive\");\n                                }\n\n                            });\n                        }\n                    }\n                });\n                observer.observe(footertargetNode, { attributes: true, childList: true });\n            }\n\n            var targetNode = document.querySelector('textarea[id$=_editor]');\n\n            if (targetNode !== null) {\n                let observer = new MutationObserver(function () {\n                    if (targetNode.style.display == 'none') {\n                        setTimeout(initIframeListeners, 100);\n                    }\n                });\n                observer.observe(targetNode, { attributes: true, childList: true });\n            }\n\n            const initIframeListeners = () => {\n\n                let iframes = document.querySelectorAll('[data-fieldtype=\"editor\"] iframe');\n                if (iframes === null || !iframes.length) {\n                    return false;\n                }\n                iframes.forEach((iframe) => {\n                    iframe.contentDocument.addEventListener('click', function () {\n                        iframes.forEach((frame) => {\n                            var frameElem = frame.contentDocument.querySelector(\".insertatcaretactive\");\n                            if (frameElem !== null) {\n                                frameElem.classList.remove(\"insertatcaretactive\");\n                            }\n                        });\n\n                        var contentBody = iframe.contentDocument.querySelector('body');\n                        if (contentBody !== null) {\n                            contentBody.classList.add(\"insertatcaretactive\");\n                        }\n                    });\n                });\n\n                return true;\n            };\n\n\n            var clickforword = document.getElementsByClassName('clickforword');\n            for (var i = 0; i < clickforword.length; i++) {\n                clickforword[i].addEventListener('click', function (e) {\n                    e.preventDefault(); // To prevent the default behaviour of a tag.\n\n                    var content = \"{\" + this.getAttribute('data-text') + \"}\";\n                    let iframes = document.querySelectorAll('[data-fieldtype=\"editor\"] iframe');\n\n                    // Copy the placeholder field.\n                    navigator.clipboard.writeText(content);\n\n                    if (iframes === null || !iframes.length) {\n                        var headerNode = document.querySelector('#admin-notificationheader iframe');\n                        if (headerNode !== null) {\n                            // Header notification editor.\n                            var headerNodeiframe = headerNode.contentDocument;\n                            if (headerNodeiframe !== null) {\n                                var headercontentBody = headerNodeiframe.querySelector(\"body\");\n                                if (headercontentBody.classList.contains(\"insertatcaretactive\")) {\n                                    headercontentBody.classList.add(\"insertatcaretactive\");\n                                    const id = headercontentBody.dataset.id;\n                                    var headereditor = window.tinyMCE.get(id);\n                                    headereditor.selection.setContent(content);\n                                    return true;\n                                }\n                            }\n                        }\n\n                        var footerNode = document.querySelector('#admin-notificationfooter iframe');\n                        if (footerNode !== null) {\n                            // Footer notification editor.\n                            var footerNodeiframe = footerNode.contentDocument;\n                            if (footerNodeiframe !== null) {\n                                var footercontentBody = footerNodeiframe.querySelector(\"body\");\n                                if (footercontentBody.classList.contains(\"insertatcaretactive\")) {\n                                    footercontentBody.classList.add(\"insertatcaretactive\");\n                                    const id = footercontentBody.dataset.id;\n                                    var footereditor = window.tinyMCE.get(id);\n                                    footereditor.selection.setContent(content);\n                                    return true;\n                                }\n                            }\n                        }\n                    }\n\n                    var tinyEditor;\n                    iframes.forEach(function (frame) {\n                        var frameElem = frame.contentDocument.querySelector(\".insertatcaretactive\");\n                        if (frameElem !== null) {\n                            var contentBody = frame.contentDocument.querySelector('body');\n                            if (contentBody !== null) {\n                                contentBody.classList.add(\"insertatcaretactive\");\n                                const id = contentBody.dataset.id;\n                                var editor = window.tinyMCE.get(id);\n                                tinyEditor = editor;\n                            }\n                        }\n                    });\n\n                    if (tinyEditor) {\n                        tinyEditor.selection.setContent(content);\n                    } else {\n                        module.insertAtCaret(content);\n                    }\n\n                    return true;\n                });\n            }\n\n            // Make selected roles as badges in module edit form page.\n            if (document.getElementById('page-mod-pulse-mod') !== null && document.getElementById('page-mod-pulse-mod')\n                .querySelector(\"#fgroup_id_completionrequireapproval [data-fieldtype='autocomplete']\") !== null) {\n                const textNodes = this.getAllTextNodes(\n                    document.getElementById('page-mod-pulse-mod')\n                        .querySelector(\"#fgroup_id_completionrequireapproval [data-fieldtype='autocomplete']\")\n                );\n                textNodes.forEach(node => {\n                    const span = document.createElement('span');\n                    span.classList = 'badge badge-info pulse-completion-roles';\n                    node.after(span);\n                    span.appendChild(node);\n                });\n            }\n        },\n\n        insertCaretActive: function (EditorInput) {\n            if (EditorInput === null) {\n                return;\n            }\n            var caret = document.getElementsByClassName(\"insertatcaretactive\");\n            for (var j = 0; j < caret.length; j++) {\n                caret[j].classList.remove(\"insertatcaretactive\");\n            }\n            EditorInput.classList.add(\"insertatcaretactive\");\n        },\n\n        /**\n         * Filter text from node.\n         * @param  {string} element\n         * @returns {array} list of childNodes.\n         */\n        getAllTextNodes: function (element) {\n            return Array.from(element.childNodes)\n                .filter(node => node.nodeType === 3 && node.textContent.trim().length > 1);\n        },\n\n        /**\n         * Find the selection is inside the editor\n         *\n         * @param {string} div\n         * @returns {bool}\n         */\n        isSelectionInsideDiv: (div) => {\n            const selection = window.getSelection();\n            if (selection.rangeCount === 0) {\n                return false;\n            }\n\n            // Get the start and end nodes of the selection.\n            const startNode = selection.getRangeAt(0).startContainer;\n            const endNode = selection.getRangeAt(0).endContainer;\n\n            // Check if the start and end nodes are both descendants of the editor div.\n            return div.contains(startNode) && div.contains(endNode);\n        },\n\n        /**\n         * Insert the placeholder in selected caret place.\n         * @param  {string} myValue\n         */\n        insertAtCaret: function (myValue) {\n            var caretelements = document.getElementsByClassName(\"insertatcaretactive\");\n            var sel, range;\n            for (var n = 0; n < caretelements.length; n++) {\n                var thiselem = caretelements[n];\n\n                if (typeof thiselem.value === 'undefined' && window.getSelection && this.isSelectionInsideDiv(thiselem)) {\n                    sel = window.getSelection();\n                    if (sel.getRangeAt && sel.rangeCount) {\n                        range = sel.getRangeAt(0);\n                        range.deleteContents();\n                        range.insertNode(document.createTextNode(myValue));\n\n                        for (let position = 0; position != (myValue.length + 1); position++) {\n                            sel.modify(\"move\", \"right\", \"character\");\n                        }\n                    }\n                } else if (typeof thiselem.value === 'undefined' && document.selection && document.selection.createRange) {\n                    range = document.selection.createRange();\n                    range.text = myValue;\n                }\n\n                if (typeof thiselem.value !== 'undefined') {\n                    if (document.selection) {\n                        // For browsers like Internet Explorer.\n                        thiselem.focus();\n                        sel = document.selection.createRange();\n                        sel.text = myValue;\n                        thiselem.focus();\n                    } else if (thiselem.selectionStart || thiselem.selectionStart == '0') {\n                        // For browsers like Firefox and Webkit based.\n                        var startPos = thiselem.selectionStart;\n                        var endPos = thiselem.selectionEnd;\n                        thiselem.value = thiselem.value.substring(0, startPos)\n                            + myValue + thiselem.value.substring(endPos, thiselem.value.length);\n                        thiselem.focus();\n                        thiselem.selectionStart = startPos + myValue.length;\n                        thiselem.selectionEnd = startPos + myValue.length;\n                        thiselem.focus();\n                    } else {\n                        thiselem.value += myValue;\n                        thiselem.focus();\n                    }\n                }\n            }\n        },\n    };\n});\n"],"names":["define","init","branch","module","this","templatevars","document","getElementsByClassName","l","length","addEventListener","EditorInput","getElementById","insertCaretActive","notificationheader","notificationfooter","forEach","elem","e","target","currentTarget","querySelector","headertargetNode","MutationObserver","style","display","headercontent","contentDocument","headercontentBody","classList","add","footerBody","contains","remove","observe","attributes","childList","footertargetNode","footercontent","footercontentBody","headerBody","targetNode","setTimeout","initIframeListeners","iframes","querySelectorAll","iframe","frame","frameElem","contentBody","clickforword","i","preventDefault","content","getAttribute","navigator","clipboard","writeText","headerNode","headerNodeiframe","id","dataset","window","tinyMCE","get","selection","setContent","footerNode","footerNodeiframe","tinyEditor","editor","insertAtCaret","getAllTextNodes","node","span","createElement","after","appendChild","caret","j","element","Array","from","childNodes","filter","nodeType","textContent","trim","isSelectionInsideDiv","div","getSelection","rangeCount","startNode","getRangeAt","startContainer","endNode","endContainer","myValue","sel","range","caretelements","n","thiselem","value","deleteContents","insertNode","createTextNode","position","modify","createRange","text","focus","selectionStart","startPos","endPos","selectionEnd","substring"],"mappings":"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"}